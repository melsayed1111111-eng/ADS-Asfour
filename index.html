<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>الشؤون الإدارية - كريستال عصفور</title>
    
    <link rel="icon" href="https://www.asfourcrystal.com/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="https://cdn-icons-png.flaticon.com/512/266/266518.png" type="image/png">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root { --main-color: #003366; --accent-color: #d4af37; --bg-light: #f4f6f9; --sidebar-width: 260px; }
        body { font-family: 'Tajawal', sans-serif; margin: 0; height: 100vh; overflow: hidden; }
        
        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 2000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--main-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Login Screen (الخلفية الخارجية) */
        .login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(rgba(0, 51, 102, 0.85), rgba(0, 26, 51, 0.9)), 
                        url('https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; padding: 20px; box-sizing: border-box; 
        }
        
        .login-box { 
            background: rgba(255, 255, 255, 0.9); 
            padding: 30px; border-radius: 12px; width: 100%; max-width: 350px; text-align: center; border-top: 5px solid var(--accent-color); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); 
            backdrop-filter: blur(10px); /* تأثير الزجاج */
        }
        .designer-credit { margin-top: 20px; color: rgba(255,255,255,0.8); font-size: 12px; font-family: sans-serif; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }

        /* UI Elements */
        .form-control { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: inherit; font-size: 14px; background: rgba(255,255,255,0.8); }
        .btn { border: none; padding: 12px 15px; border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold; color: white; display: inline-block; font-size: 14px; }
        .btn-primary { background: var(--main-color); width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary:hover { background: var(--accent-color); color: #000; transform: translateY(-2px); }
        .btn-danger { background: #c0392b; width: auto; font-size: 12px; padding: 8px 12px; }
        .btn-edit { background: var(--accent-color); width: auto; font-size: 12px; color: #000; padding: 8px 12px; }

        /* Layout */
        .app-container { display: flex; height: 100vh; display: none; position: relative; }
        
        .mobile-header {
            display: none; 
            background: var(--main-color);
            color: white;
            padding: 15px;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0; left: 0; right: 0;
            z-index: 100;
            height: 60px;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .sidebar { 
            width: var(--sidebar-width); 
            background: linear-gradient(180deg, #003366 0%, #001a33 100%); /* تدرج لوني للقائمة */
            color: white; 
            display: flex; 
            flex-direction: column; 
            transition: 0.3s;
            box-shadow: 4px 0 15px rgba(0,0,0,0.1);
            z-index: 99;
        }

        .brand { padding: 25px 20px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.1); }
        .menu-item { padding: 15px 25px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; border-right: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(255,255,255,0.1); border-right-color: var(--accent-color); }
        
        /* --- Internal Background & Main Content --- */
        .main-content { 
            flex: 1; 
            padding: 30px; 
            overflow-y: auto; 
            width: 100%; 
            /* الخلفية الداخلية الاحترافية */
            background: linear-gradient(rgba(244, 246, 249, 0.90), rgba(244, 246, 249, 0.90)),
                        url('https://images.unsplash.com/photo-1497366216548-37526070297c?q=80&w=2069&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* يجعل الخلفية ثابتة أثناء التمرير */
        }
        
        /* Components with Glass Effect */
        .table-container { 
            background: rgba(255, 255, 255, 0.85); /* شبه شفاف */
            backdrop-filter: blur(10px); /* تأثير الضبابية */
            padding: 20px; border-radius: 12px; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.05); 
            margin-bottom: 20px; overflow-x: auto; 
            border: 1px solid rgba(255,255,255,0.6);
        }

        /* تحسين شكل الجداول */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; min-width: 600px; }
        th { background: rgba(0, 51, 102, 0.1); color: var(--main-color); padding: 15px; border-bottom: 2px solid var(--main-color); text-align: right; white-space: nowrap; border-radius: 4px; }
        td { padding: 12px; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: right; }
        tr:hover { background-color: rgba(255,255,255,0.8); }
        
        /* Chat Layout */
        .chat-layout { 
            display: flex; height: 500px; 
            background: rgba(255, 255, 255, 0.9); /* شفافية للشات */
            backdrop-filter: blur(10px);
            border-radius: 12px; overflow: hidden; 
            box-shadow: 0 8px 32px rgba(0,0,0,0.05); 
            position: relative; 
            border: 1px solid rgba(255,255,255,0.6);
        }
        .chat-users { width: 30%; background: rgba(248, 249, 250, 0.8); border-left: 1px solid rgba(0,0,0,0.1); overflow-y: auto; }
        .chat-main { width: 70%; display: flex; flex-direction: column; background: transparent; }
        
        .chat-user-item { padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 10px; position: relative; transition: 0.2s; }
        .chat-user-item:hover { background: rgba(0,0,0,0.05); }
        .chat-user-item.active { background: rgba(0, 51, 102, 0.1); border-right: 4px solid var(--main-color); }
        .chat-box { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; font-size: 14px; word-wrap: break-word; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg.sent { background: var(--main-color); color: white; align-self: flex-end; border-bottom-left-radius: 0; }
        .msg.received { background: white; color: #333; align-self: flex-start; border-bottom-right-radius: 0; }
        
        /* Notification Badge */
        .badge-notify { background-color: #c0392b; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; display: flex; align-items: center; justify-content: center; position: absolute; left: 10px; top: 50%; transform: translateY(-50%); font-weight: bold; box-shadow: 0 2px 5px rgba(192, 57, 43, 0.4); }

        .admin-panel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stats-grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:20px; }
        
        .stat-card {
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(5px);
            padding: 20px; border-radius: 12px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.3s;
        }
        .stat-card:hover { transform: translateY(-5px); }

        /* Media Queries */
        @media (max-width: 768px) {
            .mobile-header { display: flex; }
            .sidebar { position: fixed; top: 60px; right: -100%; bottom: 0; width: 260px; z-index: 999; }
            .sidebar.active { right: 0; }
            .main-content { padding: 15px; padding-top: 75px; }
            .admin-panel-grid, .stats-grid { grid-template-columns: 1fr; }
            .chat-users { width: 100%; }
            .chat-main { width: 100%; position: absolute; top: 0; left: 0; right: 0; bottom: 0; transform: translateX(-100%); transition: 0.3s; z-index: 10; background: #f4f6f9; }
            .chat-layout.mobile-chat-active .chat-main { transform: translateX(0); }
            .chat-layout.mobile-chat-active .chat-users { display: none; }
            #chatBackBtn { display: inline-block !important; margin-left: 10px; color: var(--main-color); font-size: 18px; cursor: pointer; }
        }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p>جاري تحميل النظام...</p></div>

<!-- Mobile Header -->
<div class="mobile-header">
    <div onclick="toggleSidebar()" style="font-size: 24px; cursor: pointer;"><i class="fas fa-bars"></i></div>
    <div style="font-weight: bold;">كريستال عصفور</div>
    <div><i class="fas fa-gem"></i></div>
</div>

<!-- Login -->
<div class="login-overlay" id="loginScreen" style="display:none;">
    <div class="login-box">
        <h2 style="color:var(--main-color)">كريستال عصفور</h2>
        <p>إدارة الشؤون الإدارية</p>
        <input type="text" id="username" class="form-control" placeholder="اسم المستخدم" onkeyup="if(event.key === 'Enter') attemptLogin()">
        <input type="password" id="password" class="form-control" placeholder="كلمة المرور" onkeyup="if(event.key === 'Enter') attemptLogin()">
        <button class="btn btn-primary" onclick="attemptLogin()">تسجيل الدخول</button>
    </div>
    <div class="designer-credit">Designed by Eng. Mohamed Salah</div>
</div>

<!-- Main App -->
<div class="app-container" id="appContainer">
    
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="brand">
            <i class="fas fa-gem fa-2x" style="color:var(--accent-color)"></i>
            <h3>كريستال عصفور</h3>
        </div>
        <div class="menu-item active" onclick="switchTab('home')"><i class="fas fa-home"></i> الرئيسية</div>
        <div class="menu-item" onclick="switchTab('tasks')"><i class="fas fa-clipboard-list"></i> المهام</div>
        <div class="menu-item" onclick="switchTab('chat')">
            <i class="fas fa-comments"></i> المراسلات 
            <span id="total-notif" style="display:none; width:10px; height:10px; background:red; border-radius:50%; margin-right:5px;"></span>
        </div>
        <div class="menu-item" id="nav-users" style="display:none;" onclick="switchTab('admin')"><i class="fas fa-cogs"></i> لوحة الإدارة</div>
        
        <div style="margin-top:auto; padding:20px;">
            <div id="currentUserDisplay" style="font-weight:bold;">User</div>
            <div id="currentDeptDisplay" style="font-size:12px; color:var(--accent-color);">Dept</div>
            <button onclick="location.reload()" style="background:none; border:none; color:white; margin-top:10px; cursor:pointer;"><i class="fas fa-sign-out-alt"></i> خروج</button>
        </div>
    </div>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:900;"></div>

    <div class="main-content">
        <!-- Home -->
        <div id="tab-home" class="content-section">
            <div class="table-container">
                <h2 style="color:var(--main-color)">لوحة المعلومات</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>المهام</h3><span id="stat-tasks" style="font-size:24px; font-weight:bold; color:var(--main-color)">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>الموظفين</h3><span id="stat-users" style="font-size:24px; font-weight:bold; color:var(--main-color)">0</span>
                    </div>
                    <div class="stat-card">
                        <h3>الأقسام</h3><span id="stat-depts" style="font-size:24px; font-weight:bold; color:var(--main-color)">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks -->
        <div id="tab-tasks" class="content-section" style="display:none;">
            <div class="table-container">
                <div style="display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; gap:10px;">
                    <h2 style="margin:0;">سجل البيانات</h2>
                    <div style="display:flex; gap:5px;">
                        <select id="adminFilter" class="form-control" style="width:150px; display:none; margin:0;" onchange="renderTasksTable()"></select>
                        <button class="btn" style="background:#217346; padding:8px 12px;" onclick="exportExcel()">Excel <i class="fas fa-file-excel"></i></button>
                    </div>
                </div>
                <div id="taskInputArea" style="display:none; background:rgba(244, 246, 249, 0.5); padding:15px; border-radius:8px; margin-top:20px; margin-bottom:20px; border:1px solid #ddd;">
                    <h4>إدخال جديد</h4>
                    <div id="dynamicInputs" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"></div>
                    <button class="btn btn-primary" style="margin-top:15px; width:auto;" onclick="submitTask()">حفظ</button>
                </div>
                <table id="mainTasksTable">
                    <thead><tr><th>التاريخ</th><th>الموظف</th><th>القسم</th><th>المهمة</th><th>القيمة</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Chat -->
        <div id="tab-chat" class="content-section" style="display:none;">
            <div class="chat-layout" id="chatLayout">
                <div class="chat-users" id="chatUsersList"></div>
                <div class="chat-main">
                    <div style="padding:15px; border-bottom:1px solid rgba(0,0,0,0.1); font-weight:bold; display:flex; align-items:center;" id="chatHeader">
                        <i id="chatBackBtn" class="fas fa-arrow-right" style="display:none;" onclick="closeChatMobile()"></i>
                        <span style="flex:1; text-align:center;">اختر مستخدماً</span>
                    </div>
                    <div class="chat-box" id="chatBox"></div>
                    <div style="padding:15px; border-top:1px solid rgba(0,0,0,0.1); display:flex; gap:10px;">
                        <input type="text" id="msgInput" class="form-control" style="margin:0;" placeholder="اكتب...">
                        <button class="btn btn-primary" style="width:50px;" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin -->
        <div id="tab-admin" class="content-section" style="display:none;">
            <div class="admin-panel-grid">
                <!-- إدارة الأقسام -->
                <div class="table-container">
                    <h3><i class="fas fa-building"></i> إدارة الأقسام وعناوين البيانات</h3>
                    <div style="background:rgba(244, 246, 249, 0.5); padding:10px; border-radius:5px; margin-bottom:10px; border:1px solid #ddd;">
                        <input type="hidden" id="edit_dept_id">
                        <label style="font-size:12px; font-weight:bold;">اسم القسم</label>
                        <input type="text" id="new_dept_name" class="form-control" placeholder="اسم القسم">
                        
                        <label style="font-size:12px; font-weight:bold; color:#c0392b;">عناوين سجل البيانات (افصل بينها بفاصلة)</label>
                        <input type="text" id="new_dept_tasks" class="form-control" placeholder="مثال: استهلاك وقود, مأموريات, صيانة">
                        
                        <button class="btn btn-primary" id="saveDeptBtn" onclick="saveDept()">إضافة / حفظ التعديلات</button>
                        <button class="btn btn-danger" id="cancelDeptBtn" onclick="resetDeptForm()" style="display:none;">إلغاء</button>
                    </div>
                    <div style="max-height:300px; overflow-y:auto;">
                        <table id="deptTable" style="font-size:13px;">
                            <thead><tr><th>القسم والبيانات</th><th>تحكم</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- إدارة الموظفين -->
                <div class="table-container">
                    <h3><i class="fas fa-users-cog"></i> الموظفين</h3>
                    <div style="background:rgba(244, 246, 249, 0.5); padding:10px; border-radius:5px; margin-bottom:10px; border:1px solid #ddd;">
                        <input type="hidden" id="edit_user_id">
                        <input type="text" id="user_name" class="form-control" placeholder="الاسم">
                        <input type="text" id="user_pass" class="form-control" placeholder="كلمة المرور">
                        <select id="user_dept" class="form-control"></select>
                        <button class="btn btn-primary" id="saveUserBtn" onclick="saveUser()">حفظ</button>
                        <button class="btn btn-danger" id="cancelEditBtn" onclick="resetUserForm()" style="display:none;">إلغاء</button>
                    </div>
                    <div style="max-height:300px; overflow-y:auto;">
                        <table id="usersTable" style="font-size:13px;">
                            <thead><tr><th>الاسم</th><th>القسم</th><th>تحكم</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="designer-credit" style="color:#333; text-align:center; margin-top:30px; margin-bottom: 20px;">
            Designed & Developed by <strong>Eng. Mohamed Salah</strong>
        </div>
    </div>
</div>

<script>
    // --- Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyBnUnxJsxKdINvRXwnOnp-KyWBNuZ9pUhs",
  authDomain: "asfourcrystal-a743d.firebaseapp.com",
  databaseURL: "https://asfourcrystal-a743d-default-rtdb.firebaseio.com",
  projectId: "asfourcrystal-a743d",
  storageBucket: "asfourcrystal-a743d.firebasestorage.app",
  messagingSenderId: "723647578318",
  appId: "1:723647578318:web:181f9012ea1172c461109f",
  measurementId: "G-RMES8SSMKQ"
    };

    let db;
    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        document.getElementById('loader').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
    } catch (e) {
        console.error("Firebase Init Error");
        document.getElementById('loader').innerHTML = '<p style="color:red; direction:rtl;">خطأ في الاتصال بالنظام</p>';
    }

    // --- State ---
    let currentUser = null;
    let departments = {};
    let allUsers = [];
    let allTasks = [];
    let allMessages = []; 
    let chatRef = null;
    let currentChatPartnerId = null;

    // --- Mobile Functions ---
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        sidebar.classList.toggle('active');
        if (sidebar.classList.contains('active')) {
            overlay.style.display = 'block';
        } else {
            overlay.style.display = 'none';
        }
    }

    function closeChatMobile() {
        document.getElementById('chatLayout').classList.remove('mobile-chat-active');
        currentChatPartnerId = null;
    }

    // --- Core Functions ---

    function loadDepartments(callback) {
        if (!db) return;
        db.ref('departments').on('value', function(snap) {
            const val = snap.val();
            if (val) {
                departments = val;
            } else {
                const defaults = {
                    'admin': { name: 'الإدارة العامة', tasks: [] },
                    'buffet': { name: 'البوفيه', tasks: ['مشروبات', 'وجبات', 'نظافة'] },
                    'movement': { name: 'الحركة', tasks: ['مأموريات', 'وقود', 'صيانة'] },
                    'telecom': { name: 'اتصالات', tasks: ['فواتير', 'خطوط', 'أعطال'] }
                };
                db.ref('departments').set(defaults);
                departments = defaults;
            }
            document.getElementById('stat-depts').innerText = Object.keys(departments).length;
            renderDeptTable(); 
            if (callback) callback();
        });
    }

    function attemptLogin() {
        const u = document.getElementById('username').value.trim();
        const p = document.getElementById('password').value.trim();
        if (!u || !p) return alert("أدخل البيانات");

        db.ref('users').once('value', function(snap) {
            const users = snap.val();
            
            if (!users && u === 'admin' && p === '123') {
                const newAdmin = { username: 'admin', password: '123', role: 'admin', dept: 'admin' };
                db.ref('users').push(newAdmin);
                initSession({ ...newAdmin, id: 'temp-admin' });
                return;
            }

            let found = null;
            if (users) {
                for (const k in users) {
                    if (users[k].username === u && users[k].password === p) {
                        found = { ...users[k], id: k };
                        break;
                    }
                }
            }

            if (found) initSession(found);
            else alert("بيانات خاطئة");
        });
    }

    function initSession(user) {
        currentUser = user;
        loadDepartments(function() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            document.getElementById('currentUserDisplay').innerText = user.username;
            
            let deptName = user.dept;
            if (departments[user.dept] && departments[user.dept].name) {
                deptName = departments[user.dept].name;
            }
            document.getElementById('currentDeptDisplay').innerText = deptName;

            if (user.role === 'admin') {
                document.getElementById('nav-users').style.display = 'flex';
                document.getElementById('adminFilter').style.display = 'block';
                setupAdminDropdowns();
                listenToAllUsers();
            } else {
                document.getElementById('taskInputArea').style.display = 'block';
                renderTaskInputs();
            }

            listenToTasks();
            listenToAllMessages(); 
            listenToChatUsers();
            switchTab('home');
        });
    }

    // --- Admin Logic: Departments ---

    function setupAdminDropdowns() {
        const filter = document.getElementById('adminFilter');
        const userDept = document.getElementById('user_dept');
        filter.innerHTML = '<option value="all">كل الأقسام</option>';
        userDept.innerHTML = '';
        
        for (const k in departments) {
            userDept.innerHTML += '<option value="' + k + '">' + departments[k].name + '</option>';
            if (k !== 'admin') {
                filter.innerHTML += '<option value="' + k + '">' + departments[k].name + '</option>';
            }
        }
    }

    function saveDept() {
        const id = document.getElementById('edit_dept_id').value;
        const name = document.getElementById('new_dept_name').value;
        const tasksStr = document.getElementById('new_dept_tasks').value;
        
        if (!name) return alert("الاسم مطلوب");
        
        const tasksArr = tasksStr.split(/,|،/).map(function(t) { return t.trim(); }).filter(function(t) { return t; });
        
        if (id) {
            db.ref('departments/' + id).update({ name: name, tasks: tasksArr });
            alert("تم حفظ التعديلات");
        } else {
            const deptId = 'dept_' + Date.now();
            db.ref('departments/' + deptId).set({ name: name, tasks: tasksArr });
            alert("تم إضافة القسم");
        }
        resetDeptForm();
    }

    function deleteDept(id) {
        if (id === 'admin') return alert("لا يمكن حذف قسم الإدارة");
        if (confirm("هل أنت متأكد من حذف هذا القسم؟")) {
            db.ref('departments/' + id).remove();
        }
    }

    function editDept(id) {
        const d = departments[id];
        if (!d) return;
        
        document.getElementById('edit_dept_id').value = id;
        document.getElementById('new_dept_name').value = d.name;
        
        let tStr = '';
        if (d.tasks && Array.isArray(d.tasks)) {
            tStr = d.tasks.join(', ');
        }
        document.getElementById('new_dept_tasks').value = tStr;
        
        document.getElementById('saveDeptBtn').innerText = "حفظ التعديلات";
        document.getElementById('cancelDeptBtn').style.display = 'inline-block';
    }

    function resetDeptForm() {
        document.getElementById('edit_dept_id').value = '';
        document.getElementById('new_dept_name').value = '';
        document.getElementById('new_dept_tasks').value = '';
        document.getElementById('saveDeptBtn').innerText = "إضافة / حفظ التعديلات";
        document.getElementById('cancelDeptBtn').style.display = 'none';
    }

    function renderDeptTable() {
        const tbody = document.querySelector('#deptTable tbody');
        tbody.innerHTML = '';
        for (const k in departments) {
            if (k !== 'admin') {
                let taskList = departments[k].tasks;
                let taskString = 'لا توجد بيانات مسجلة';
                if (taskList && Array.isArray(taskList)) {
                    taskString = taskList.join(', ');
                }

                tbody.innerHTML += 
                    '<tr>' +
                        '<td><b>' + departments[k].name + '</b><br><small style="color:#2c3e50; font-weight:bold;">البيانات: ' + taskString + '</small></td>' +
                        '<td>' +
                            '<button class="btn btn-edit" onclick="editDept(\'' + k + '\')"><i class="fas fa-edit"></i></button> ' +
                            '<button class="btn btn-danger" onclick="deleteDept(\'' + k + '\')"><i class="fas fa-trash"></i></button>' +
                        '</td>' +
                    '</tr>';
            }
        }
    }

    // --- Admin Logic: Users ---

    function listenToAllUsers() {
        db.ref('users').on('value', function(snap) {
            const tbody = document.querySelector('#usersTable tbody');
            tbody.innerHTML = '';
            snap.forEach(function(child) {
                const u = child.val();
                const uid = child.key;
                if (u.role === 'admin') return;

                let dName = u.dept;
                if (departments[u.dept]) dName = departments[u.dept].name;

                tbody.innerHTML += 
                    '<tr>' +
                        '<td>' + u.username + '</td>' +
                        '<td>' + dName + '</td>' +
                        '<td>' +
                            '<button class="btn btn-edit" onclick="editUser(\'' + uid + '\', \'' + u.username + '\', \'' + u.password + '\', \'' + u.dept + '\')"><i class="fas fa-edit"></i></button> ' +
                            '<button class="btn btn-danger" onclick="deleteUser(\'' + uid + '\')"><i class="fas fa-trash"></i></button>' +
                        '</td>' +
                    '</tr>';
            });
        });
    }

    function saveUser() {
        const id = document.getElementById('edit_user_id').value;
        const name = document.getElementById('user_name').value;
        const pass = document.getElementById('user_pass').value;
        const dept = document.getElementById('user_dept').value;
        
        if (!name || !pass) return alert("أكمل البيانات");
        
        const userData = { username: name, password: pass, dept: dept, role: 'user' };
        if (id) {
            db.ref('users/' + id).update(userData);
            alert("تم التعديل");
        } else {
            db.ref('users').push(userData);
            alert("تمت الإضافة");
        }
        resetUserForm();
    }

    function deleteUser(uid) {
        if (confirm("حذف الموظف؟")) db.ref('users/' + uid).remove();
    }

    function editUser(id, name, pass, dept) {
        document.getElementById('edit_user_id').value = id;
        document.getElementById('user_name').value = name;
        document.getElementById('user_pass').value = pass;
        document.getElementById('user_dept').value = dept;
        document.getElementById('saveUserBtn').innerText = "تعديل";
        document.getElementById('cancelEditBtn').style.display = 'inline-block';
    }

    function resetUserForm() {
        document.getElementById('edit_user_id').value = '';
        document.getElementById('user_name').value = '';
        document.getElementById('user_pass').value = '';
        document.getElementById('saveUserBtn').innerText = "حفظ";
        document.getElementById('cancelEditBtn').style.display = 'none';
    }

    // --- Tasks Logic ---

    function renderTaskInputs() {
        const div = document.getElementById('dynamicInputs');
        div.innerHTML = '';
        
        let myTasks = [];
        if (departments[currentUser.dept] && departments[currentUser.dept].tasks) {
            myTasks = departments[currentUser.dept].tasks;
        }

        if (!myTasks || myTasks.length === 0) {
            div.innerHTML = '<p>لا توجد بيانات مسجلة لهذا القسم</p>';
            return;
        }

        myTasks.forEach(function(task) {
            div.innerHTML += '<div><label style="font-size:12px; font-weight:bold;">' + task + '</label><input type="text" class="form-control task-inp" data-task="' + task + '"></div>';
        });
    }

    function submitTask() {
        const inputs = document.querySelectorAll('.task-inp');
        let hasData = false;
        inputs.forEach(function(inp) {
            if (inp.value.trim()) {
                hasData = true;
                db.ref('tasks').push({
                    userId: currentUser.id,
                    username: currentUser.username,
                    dept: currentUser.dept,
                    taskName: inp.getAttribute('data-task'),
                    value: inp.value,
                    date: new Date().toLocaleDateString('ar-EG'),
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                inp.value = '';
            }
        });
        if (hasData) alert("تم الحفظ"); else alert("أدخل قيمة واحدة على الأقل");
    }

    function listenToTasks() {
        db.ref('tasks').on('value', function(snap) {
            allTasks = [];
            snap.forEach(function(c) { allTasks.push(c.val()); });
            document.getElementById('stat-tasks').innerText = allTasks.length;
            renderTasksTable();
        });
    }

    function renderTasksTable() {
        const tbody = document.querySelector('#mainTasksTable tbody');
        tbody.innerHTML = '';
        const filter = document.getElementById('adminFilter').value;
        const list = allTasks.sort(function(a, b) { return b.timestamp - a.timestamp; });

        list.forEach(function(t) {
            let show = false;
            if (currentUser.role === 'admin') {
                if (filter === 'all') show = true;
                else if (t.dept === filter) show = true;
            } else {
                if (t.userId === currentUser.id) show = true;
            }

            if (show) {
                let dName = t.dept;
                if (departments[t.dept]) dName = departments[t.dept].name;
                
                tbody.innerHTML += '<tr>' +
                    '<td>' + t.date + '</td>' +
                    '<td>' + t.username + '</td>' +
                    '<td>' + dName + '</td>' +
                    '<td>' + t.taskName + '</td>' +
                    '<td>' + t.value + '</td>' +
                '</tr>';
            }
        });
    }

    function exportExcel() {
        const tbl = document.getElementById('mainTasksTable');
        const wb = XLSX.utils.table_to_book(tbl, { sheet: "Sheet1" });
        XLSX.writeFile(wb, 'CrystalAsfour_Report.xlsx');
    }

    // --- Chat Logic & Notifications ---

    function listenToAllMessages() {
        db.ref('messages').on('value', function(snap) {
            allMessages = [];
            snap.forEach(function(c) { 
                allMessages.push({ ...c.val(), id: c.key }); 
            });
            renderChatUsersList(); 
        });
    }

    function listenToChatUsers() {
        db.ref('users').on('value', function(snap) {
            allUsers = [];
            snap.forEach(function(c) { allUsers.push({ ...c.val(), id: c.key }); });
            document.getElementById('stat-users').innerText = allUsers.length;
            renderChatUsersList();
        });
    }

    function renderChatUsersList() {
        const listDiv = document.getElementById('chatUsersList');
        listDiv.innerHTML = '';
        
        let totalUnread = 0;

        allUsers.forEach(function(u) {
            if (u.id !== currentUser.id) {
                let dName = u.dept;
                if (departments[u.dept]) dName = departments[u.dept].name;

                const unreadCount = allMessages.filter(function(m) {
                    return m.from === u.id && m.to === currentUser.id && m.read === false;
                }).length;

                if (unreadCount > 0) totalUnread += unreadCount;

                const badgeHtml = unreadCount > 0 ? '<div class="badge-notify">' + unreadCount + '</div>' : '';

                listDiv.innerHTML += 
                    '<div class="chat-user-item" id="user-item-' + u.id + '" onclick="openChat(\'' + u.id + '\', \'' + u.username + '\')">' +
                         badgeHtml +
                        '<div style="width:30px; height:30px; background:#ddd; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-user"></i></div>' +
                        '<div>' +
                            '<div style="font-weight:bold; font-size:14px;">' + u.username + '</div>' +
                            '<div style="font-size:11px; color:#777;">' + dName + '</div>' +
                        '</div>' +
                    '</div>';
            }
        });

        const notifDot = document.getElementById('total-notif');
        if (totalUnread > 0) {
            notifDot.style.display = 'inline-block';
        } else {
            notifDot.style.display = 'none';
        }
    }

    function openChat(partnerId, partnerName) {
        currentChatPartnerId = partnerId;
        document.getElementById('chatHeader').innerHTML = `<i id="chatBackBtn" class="fas fa-arrow-right" onclick="closeChatMobile()" style="cursor:pointer; margin-left:10px; display:none;"></i> <span>محادثة مع: ${partnerName}</span>`;
        
        const items = document.querySelectorAll('.chat-user-item');
        for (let i = 0; i < items.length; i++) { items[i].classList.remove('active'); }
        
        const activeItem = document.getElementById('user-item-' + partnerId);
        if (activeItem) activeItem.classList.add('active');

        // Mobile specific: show chat
        document.getElementById('chatLayout').classList.add('mobile-chat-active');

        if (chatRef) chatRef.off();
        
        markMessagesAsRead(partnerId);

        const box = document.getElementById('chatBox');
        box.innerHTML = '<div style="text-align:center; color:#999; margin-top:20px;">جاري التحميل...</div>';

        chatRef = db.ref('messages');
        chatRef.on('value', function(snap) {
            box.innerHTML = '';
            const msgs = [];
            snap.forEach(function(c) { msgs.push(c.val()); });
            msgs.sort(function(a, b) { return a.timestamp - b.timestamp; });

            let count = 0;
            msgs.forEach(function(m) {
                if ((m.from === currentUser.id && m.to === partnerId) || 
                    (m.from === partnerId && m.to === currentUser.id)) {
                    count++;
                    const cls = m.from === currentUser.id ? 'sent' : 'received';
                    box.innerHTML += '<div class="msg ' + cls + '">' + m.text + '</div>';
                }
            });

            if (count === 0) box.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:50px;">لا توجد رسائل</div>';
            box.scrollTop = box.scrollHeight;
            
            markMessagesAsRead(partnerId);
        });
    }

    function markMessagesAsRead(senderId) {
        allMessages.forEach(function(m) {
            if (m.from === senderId && m.to === currentUser.id && m.read === false) {
                db.ref('messages/' + m.id).update({ read: true });
            }
        });
    }

    function sendMsg() {
        const txt = document.getElementById('msgInput').value;
        if (!currentChatPartnerId) return alert("اختر شخصاً");
        if (txt.trim()) {
            db.ref('messages').push({
                from: currentUser.id,
                to: currentChatPartnerId,
                text: txt,
                read: false, 
                timestamp: firebase.database.ServerValue.TIMESTAMP
            });
            document.getElementById('msgInput').value = '';
        }
    }

    // --- Utils ---
    document.getElementById("msgInput").addEventListener("keyup", function(e) { 
        if (e.key === "Enter") sendMsg(); 
    });

    function switchTab(id) {
        // Hide overlay if open
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('active');
            overlay.style.display = 'none';
        }

        const sections = document.querySelectorAll('.content-section');
        for (let i = 0; i < sections.length; i++) sections[i].style.display = 'none';
        
        document.getElementById('tab-' + id).style.display = 'block';
        
        const menus = document.querySelectorAll('.menu-item');
        for (let i = 0; i < menus.length; i++) menus[i].classList.remove('active');
        
        const iconMap = { 'home': 0, 'tasks': 1, 'chat': 2, 'admin': 3 };
        if (menus[iconMap[id]]) menus[iconMap[id]].classList.add('active');
    }

</script>
</body>
</html>
